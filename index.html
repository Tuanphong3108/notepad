<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad MD3</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon.png">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FEF7FF">
    
    <!-- Google Sans Flex, Google Sans Code & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@100..1000&family=Google+Sans+Code:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-outline: #79747E;
            --md-sys-color-error: #B3261E;
            --md-sys-color-state-layer: rgba(103, 80, 164, 0.12);
            --md-sys-color-on-surface-variant: #49454F;
        }

        body {
            font-family: 'Google Sans Flex', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: #1D1B20;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- Menu & Overlay --- */
        #contextMenu, #moreOptionsMenu {
            position: fixed;
            display: none;
            background: var(--md-sys-color-surface-container);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 220px;
            padding: 8px 0;
            animation: menuFade 0.15s ease-out;
            border: 1px solid rgba(0,0,0,0.05);
        }

        @keyframes menuFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            color: #1D1B20;
        }

        .menu-item:hover:not(.disabled) { background: var(--md-sys-color-state-layer); }
        .menu-item:hover:not(.disabled) .material-symbols-outlined { font-variation-settings: 'FILL' 1; }
        .menu-item.disabled { opacity: 0.38; cursor: default; pointer-events: none; }
        .menu-item .material-symbols-outlined { font-size: 20px; transition: font-variation-settings 0.2s; }

        /* --- Header --- */
        .app-header {
            height: 64px;
            background-color: var(--md-sys-color-surface);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        #brandLogo { transition: all 0.8s ease; max-width: 200px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; }
        #brandLogo.collapsed { max-width: 40px; }
        #brandIcon { transform: scale(0); opacity: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #brandLogo.collapsed #brandIcon { transform: scale(1); opacity: 1; }
        #brandLogo.collapsed #brandText { opacity: 0; transform: translateX(-20px); pointer-events: none; }

        .action-btn {
            display: inline-flex;
            align-items: center;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            padding: 0 8px;
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            gap: 8px;
        }
        .action-btn:hover:not(.disabled) { max-width: 180px; background-color: var(--md-sys-color-state-layer); padding: 0 16px; }
        .action-btn:hover:not(.disabled) .material-symbols-outlined { font-variation-settings: 'FILL' 1; }
        .action-btn.primary { background-color: #EADDFF; color: #21005D; }
        .action-label { font-size: 14px; font-weight: 700; opacity: 0; transition: opacity 0.3s; }
        .action-btn:hover:not(.disabled) .action-label { opacity: 1; }
        .action-btn.disabled { opacity: 0.38; cursor: default; }

        /* --- Switch Overshoot --- */
        .switch { position: relative; display: inline-block; width: 52px !important; height: 32px !important; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--md-sys-color-surface-container);
            border: 2px solid var(--md-sys-color-outline);
            transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 32px;
        }
        .slider:before {
            position: absolute; content: "close"; font-family: 'Material Symbols Outlined';
            font-size: 16px; display: flex; align-items: center; justify-content: center;
            height: 24px; width: 24px; left: 2px; bottom: 2px;
            background-color: var(--md-sys-color-outline); color: white;
            transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--md-sys-color-primary); border-color: var(--md-sys-color-primary); }
        input:checked + .slider:before { content: "check"; transform: translateX(20px); background-color: var(--md-sys-color-on-primary); color: var(--md-sys-color-primary); }

        /* --- Find & Replace Bar --- */
        #findReplaceBar {
            display: none;
            background-color: var(--md-sys-color-surface-container-high);
            padding: 8px 24px;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            animation: slideDown 0.3s cubic-bezier(0, 0, 0.2, 1);
            flex-wrap: wrap;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        
        .fr-input-container {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 28px;
            padding: 0 16px;
            height: 48px;
            border: 1px solid var(--md-sys-color-outline);
            flex: 1;
            min-width: 200px;
            transition: border 0.2s;
        }
        .fr-input-container:focus-within { border-color: var(--md-sys-color-primary); border-width: 2px; }
        .fr-input { border: none; outline: none; flex: 1; font-size: 14px; padding: 0 8px; background: transparent; }

        /* --- Editor Area --- */
        #editorArea { display: flex; flex-grow: 1; overflow: hidden; background: white; position: relative; }
        .editor-wrapper { position: relative; flex: 1; display: flex; overflow: hidden; }
        
        #noteContent {
            flex: 1; padding: 40px; outline: none; border: none; resize: none;
            font-family: 'Google Sans Code', 'Consolas', monospace;
            font-size: 1rem; line-height: 1.8; color: #1D1B20; overflow-y: auto;
            background: transparent; z-index: 2; position: relative;
            border-right: 1px solid rgba(0,0,0,0.05); user-select: text;
        }

        #searchHighlights {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 40px; pointer-events: none; white-space: pre-wrap; word-wrap: break-word;
            font-family: 'Google Sans Code', 'Consolas', monospace;
            font-size: 1rem; line-height: 1.8; color: transparent; overflow: hidden;
            z-index: 1;
        }
        #searchHighlights mark { background-color: rgba(255, 235, 59, 0.4); color: transparent; border-bottom: 2px solid orange; }
        #searchHighlights mark.current { background-color: rgba(255, 152, 0, 0.6); border-bottom: 2px solid red; }

        #previewPane { flex: 1; padding: 40px; overflow-y: auto; background-color: var(--md-sys-color-surface); display: none; user-select: text; }
        #previewPane.active { display: block; }

        /* Markdown Styles */
        .markdown-body h1 { font-size: 2.25rem; font-weight: 900; color: var(--md-sys-color-primary); border-bottom: 2px solid var(--md-sys-color-outline); margin-bottom: 1rem; }
        .markdown-body strong { font-weight: 1000; color: #000; }
        .markdown-body pre { background: #1D1B20; color: #F4EFF4; padding: 1rem; border-radius: 12px; }

        #toast { visibility: hidden; min-width: 200px; background: #313033; color: #F4EFF4; border-radius: 12px; padding: 12px 24px; position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); z-index: 100; transition: 0.3s; }
        #toast.show { visibility: visible; }
        
        #loading img { filter: brightness(0) saturate(100%) invert(35%) sepia(21%) font-family(53%) hue-rotate(217deg) brightness(96%) contrast(91%); }
    </style>
</head>
<body>

    <!-- Context & More Menus -->
    <div id="contextMenu">
        <div class="menu-item" onclick="handleMenuAction('undo')"><span class="material-symbols-outlined">undo</span>Hoàn tác</div>
        <div class="menu-item" onclick="handleMenuAction('redo')"><span class="material-symbols-outlined">redo</span>Làm lại</div>
        <hr class="my-1 border-black/5">
        <div class="menu-item" onclick="toggleFindReplace()"><span class="material-symbols-outlined">search</span>Tìm kiếm & Thay thế</div>
        <hr class="my-1 border-black/5">
        <div class="menu-item" onclick="handleMenuAction('cut')"><span class="material-symbols-outlined">content_cut</span>Cắt</div>
        <div class="menu-item" onclick="handleMenuAction('copy')"><span class="material-symbols-outlined">content_copy</span>Sao chép</div>
        <div class="menu-item" onclick="handleMenuAction('paste')"><span class="material-symbols-outlined">content_paste</span>Dán</div>
        <div class="menu-item" onclick="handleMenuAction('select-all')"><span class="material-symbols-outlined">select_all</span>Chọn tất cả</div>
    </div>

    <div id="moreOptionsMenu">
        <div class="menu-item" onclick="handleMenuAction('undo')"><span class="material-symbols-outlined">undo</span>Hoàn tác <span class="ml-auto text-[10px] opacity-50">Ctrl+Z</span></div>
        <div class="menu-item" onclick="handleMenuAction('redo')"><span class="material-symbols-outlined">redo</span>Làm lại <span class="ml-auto text-[10px] opacity-50">Ctrl+Y</span></div>
        <hr class="my-1 border-black/5">
        <div class="menu-item" onclick="handleMenuAction('cut')"><span class="material-symbols-outlined">content_cut</span>Cắt <span class="ml-auto text-[10px] opacity-50">Ctrl+X</span></div>
        <div class="menu-item" onclick="handleMenuAction('copy')"><span class="material-symbols-outlined">content_copy</span>Sao chép <span class="ml-auto text-[10px] opacity-50">Ctrl+C</span></div>
        <div class="menu-item" onclick="handleMenuAction('paste')"><span class="material-symbols-outlined">content_paste</span>Dán <span class="ml-auto text-[10px] opacity-50">Ctrl+V</span></div>
        <div class="menu-item" onclick="handleMenuAction('select-all')"><span class="material-symbols-outlined">select_all</span>Chọn tất cả <span class="ml-auto text-[10px] opacity-50">Ctrl+A</span></div>
        <hr class="my-1 border-black/5">
        <div class="menu-item" onclick="toggleFindReplace()"><span class="material-symbols-outlined">search</span>Tìm kiếm & Thay thế <span class="ml-auto text-[10px] opacity-50">Ctrl+F</span></div>
        <hr class="my-1 border-black/5">
<div class="menu-item" onclick="restartApp()">
    <span class="material-symbols-outlined">restart_alt</span>
    Khởi động lại
</div>

    </div>

    <header class="app-header">
        <div class="flex items-center gap-2 overflow-hidden flex-shrink-0">
            <div id="brandLogo" class="flex items-center text-[#6750A4] mr-2">
                <span id="brandIcon" class="material-symbols-outlined text-3xl flex-shrink-0 mr-2">description</span>
                <span id="brandText" class="font-black text-xl tracking-tight">Notepad</span>
            </div>
            
            <div class="flex items-center gap-1">
                <button onclick="newFile()" class="action-btn text-[#B3261E]"><span class="material-symbols-outlined">note_add</span><span class="action-label">Tạo tệp mới</span></button>
                <button onclick="openFile()" class="action-btn"><span class="material-symbols-outlined">file_open</span><span class="action-label">Mở tệp</span></button>
                <button id="mainSaveBtn" onclick="saveFile()" class="action-btn primary hidden"><span class="material-symbols-outlined">save</span><span class="action-label">Lưu tệp</span></button>
                <button id="saveAsBtn" onclick="saveFileAs()" class="action-btn primary"><span class="material-symbols-outlined">save_as</span><span class="action-label">Lưu bản mới</span></button>
            </div>
            <div class="w-[1px] h-6 bg-black/10 mx-2"></div>
            <input type="text" id="noteTitle" readonly placeholder="Không tên" class="bg-transparent text-sm font-bold outline-none border-none text-left w-24 sm:w-32 lg:w-48 placeholder:text-black/30 border-b border-transparent focus:border-black/10 transition-colors" autocomplete="off">
        </div>

        <div id="mdToolbar" class="hidden sm:flex items-center gap-0.5 bg-[#F7F2FA] px-2 py-1 rounded-full border border-black/5 opacity-0 transition-all">
            <button onclick="insertMD('**', '**')" class="action-btn !max-w-[40px] text-[#49454F]"><span class="material-symbols-outlined">format_bold</span></button>
            <button onclick="insertMD('*', '*')" class="action-btn !max-w-[40px] text-[#49454F]"><span class="material-symbols-outlined">format_italic</span></button>
            <button onclick="insertMD('# ', '')" class="action-btn !max-w-[40px] text-[#49454F]"><span class="material-symbols-outlined">format_size</span></button>
            <button onclick="insertMD('`', '`')" class="action-btn !max-w-[40px] text-[#49454F]"><span class="material-symbols-outlined">code</span></button>
        </div>

        <div class="flex items-center gap-3 flex-shrink-0">
            <div id="saveStatus" class="text-[#381E72] opacity-0 transition-opacity"><span class="material-symbols-outlined text-lg">sync_saved_locally</span></div>
            <div class="flex items-center gap-3">
<div id="autoSaveContainer" class="hidden items-center gap-2">

    <!-- WORD COUNT -->
    <span id="wordCount" class="text-[11px] font-bold text-black/40">0 ký tự</span>

    <label class="switch">
        <input type="checkbox" id="autoSaveToggle">
        <span class="slider"></span>
    </label>

    <span class="hidden md:inline text-[10px] font-black uppercase text-[#21005D]">
        Auto Save
    </span>

</div>


            </div>
            <div class="w-[1px] h-6 bg-black/10"></div>
            <button id="moreOptionsBtn" class="action-btn !max-w-[40px] text-[#49454F]"><span class="material-symbols-outlined">more_vert</span></button>
        </div>
    </header>

    <!-- Find & Replace Bar -->
    <div id="findReplaceBar">
        <div class="fr-input-container">
            <span class="material-symbols-outlined text-black/50">search</span>
            <input type="text" id="findInput" class="fr-input" placeholder="Tìm kiếm...">
            <span id="findCount" class="text-[10px] font-bold text-black/40 mr-2">0/0</span>
            <button onclick="findNext(false)" class="p-1 hover:bg-black/5 rounded-full"><span class="material-symbols-outlined text-lg">keyboard_arrow_up</span></button>
            <button onclick="findNext(true)" class="p-1 hover:bg-black/5 rounded-full"><span class="material-symbols-outlined text-lg">keyboard_arrow_down</span></button>
        </div>
        <div class="fr-input-container">
            <span class="material-symbols-outlined text-black/50">find_replace</span>
            <input type="text" id="replaceInput" class="fr-input" placeholder="Thay thế bằng...">
            <button onclick="replaceOne()" class="text-[10px] font-black uppercase px-2 py-1 hover:bg-black/5 rounded">Thay thế</button>
            <button onclick="replaceAll()" class="text-[10px] font-black uppercase px-2 py-1 hover:bg-black/5 rounded">Tất cả</button>
        </div>
        <button onclick="toggleFindReplace()" class="p-2 hover:bg-black/5 rounded-full"><span class="material-symbols-outlined">close</span></button>
    </div>

    <main id="editorArea">
        <div class="editor-wrapper">
            <div id="searchHighlights"></div>
            <textarea id="noteContent" spellcheck="false" placeholder="Bắt đầu viết..."></textarea>
        </div>
        <div id="previewPane" class="markdown-body"></div>
    </main>

    <div id="toast">Thông báo</div>
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-md flex flex-col items-center justify-center z-[100] hidden">
        <img src="https://tuanphong3108.github.io/md3-loading/Loading_Indicator.gif" alt="Loading" class="w-16" style="filter: brightness(0) saturate(100%) invert(35%) sepia(21%) saturate(53%) hue-rotate(217deg) brightness(96%) contrast(91%);">
        <p class="mt-4 font-black text-[#6750A4] uppercase tracking-widest text-[10px]">Đang xử lý</p>
    </div>

    <div id="autoSavePrompt" class="fixed inset-0 bg-black/30 flex items-center justify-center z-[200] hidden">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-[320px]">
        <h2 class="text-lg font-black mb-2">Bạn có muốn bật Auto Save?</h2>
        <p class="text-sm text-black/60 mb-4">
            Khi bật, nội dung sẽ tự động được lưu sau mỗi lần chỉnh sửa để tránh mất dữ liệu ngoài ý muốn.
        </p>
        <div class="flex justify-end gap-2">
            <button onclick="closeAutoSavePrompt()" class="px-4 py-2 rounded-full hover:bg-black/5 font-bold text-sm">
                Không
            </button>
            <button onclick="enableAutoSave()" class="px-4 py-2 rounded-full bg-[#6750A4] text-white font-bold text-sm">
                Bật
            </button>
        </div>
    </div>
</div>

    <script>
        const wordCount = document.getElementById('wordCount');
        const contentInput = document.getElementById('noteContent');
        const searchHighlights = document.getElementById('searchHighlights');
        const previewPane = document.getElementById('previewPane');
        const contextMenu = document.getElementById('contextMenu');
        const moreOptionsMenu = document.getElementById('moreOptionsMenu');
        const moreOptionsBtn = document.getElementById('moreOptionsBtn');
        const brandLogo = document.getElementById('brandLogo');
        const titleInput = document.getElementById('noteTitle');
        const mainSaveBtn = document.getElementById('mainSaveBtn');
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        const autoSaveContainer = document.getElementById('autoSaveContainer');
        const spellCheckToggle = document.getElementById('spellCheckToggle');
        const toast = document.getElementById('toast');
        const mdToolbar = document.getElementById('mdToolbar');
        const saveStatus = document.getElementById('saveStatus');
        const loading = document.getElementById('loading');
        const findReplaceBar = document.getElementById('findReplaceBar');
        const findInput = document.getElementById('findInput');
        const replaceInput = document.getElementById('replaceInput');
        const findCountDisplay = document.getElementById('findCount');
        const autoSavePrompt = document.getElementById('autoSavePrompt');
        

        let fileHandle = null;
        let isMarkdown = false;
        let searchResults = [];
        let currentSearchIndex = -1;
        let isSaved = true;

        // Custom History Manager
        const history = {
            stack: [""],
            pointer: 0,
            push(val) {
                if (val === this.stack[this.pointer]) return;
                this.stack = this.stack.slice(0, this.pointer + 1);
                this.stack.push(val);
                if (this.stack.length > 50) this.stack.shift();
                else this.pointer++;
            },
            undo() {
                if (this.pointer > 0) return this.stack[--this.pointer];
                return null;
            },
            redo() {
                if (this.pointer < this.stack.length - 1) return this.stack[++this.pointer];
                return null;
            }
        };

        // --- NEW: PWA launchQueue handling ---
        if ('launchQueue' in window) {
            window.launchQueue.setConsumer(async (launchParams) => {
                if (launchParams.files.length > 0) {
                    const handle = launchParams.files[0];
                    await loadFileFromHandle(handle);
                }
            });
        }

        async function loadFileFromHandle(handle) {
            fileHandle = handle;
            loading.classList.remove('hidden');
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                contentInput.value = text;
                history.push(text);
                titleInput.value = file.name;
                updateWindowTitle();   // ← PHẦN C NẰM NGAY ĐÂY
                checkFileType(file.name);
                if (!autoSaveToggle.checked) {
                    showAutoSavePrompt();
                }
                isSaved = true;
                updateSaveUI();
                renderPreview();
                updateWordCount();
                showToast(`Đã mở: ${file.name}`);
            } catch (err) {
                showToast("Không thể mở file!");
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(() => {}); });
        }

        // UI Events
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const rect = moreOptionsBtn.getBoundingClientRect();
            moreOptionsMenu.style.display = 'block';
            moreOptionsMenu.style.right = (window.innerWidth - rect.right) + 'px';
            moreOptionsMenu.style.top = (rect.bottom + 8) + 'px';
        });

        window.addEventListener('click', () => { 
            contextMenu.style.display = 'none'; 
            moreOptionsMenu.style.display = 'none';
        });

        // Search Engine
        function toggleFindReplace() {
            const isVisible = findReplaceBar.style.display === 'flex';
            findReplaceBar.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) { findInput.focus(); performSearch(); } 
            else { contentInput.focus(); searchHighlights.innerHTML = ""; }
        }

        findInput.addEventListener('input', performSearch);
        contentInput.addEventListener('scroll', () => {
            searchHighlights.scrollTop = contentInput.scrollTop;
            searchHighlights.scrollLeft = contentInput.scrollLeft;
        });

        function performSearch() {
            const query = findInput.value;
            const text = contentInput.value;
            if (!query) { 
                searchResults = []; currentSearchIndex = -1; searchHighlights.innerHTML = ""; updateSearchUI(); return; 
            }
            searchResults = [];
            let pos = 0;
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            while ((pos = lowerText.indexOf(lowerQuery, pos)) !== -1) {
                searchResults.push({ start: pos, end: pos + query.length });
                pos += query.length;
            }
            let highlightedHtml = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            if (searchResults.length > 0) {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedQuery})`, 'gi');
                let i = 0;
                highlightedHtml = highlightedHtml.replace(regex, (match) => {
                    const isCurrent = (i === currentSearchIndex);
                    const html = `<mark class="${isCurrent ? 'current' : ''}">${match}</mark>`;
                    i++; return html;
                });
                if (currentSearchIndex === -1) currentSearchIndex = 0;
                highlightResult();
            } else { currentSearchIndex = -1; }
            searchHighlights.innerHTML = highlightedHtml + "\n\n";
            updateSearchUI();
        }

        function updateSearchUI() {
            findCountDisplay.innerText = searchResults.length === 0 ? "0/0" : `${currentSearchIndex + 1}/${searchResults.length}`;
        }

        function findNext(forward = true) {
            if (searchResults.length === 0) return;
            currentSearchIndex = forward ? (currentSearchIndex + 1) % searchResults.length : (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            performSearch();
        }

        function highlightResult() {
            if (currentSearchIndex === -1 || searchResults.length === 0) return;
            const result = searchResults[currentSearchIndex];
            contentInput.setSelectionRange(result.start, result.end);
            const lineHeight = parseInt(window.getComputedStyle(contentInput).lineHeight);
            const linesBefore = contentInput.value.substring(0, result.start).split('\n').length;
            const scrollTarget = (linesBefore * lineHeight) - (contentInput.clientHeight / 2);
            contentInput.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }

        function replaceOne() {
            if (currentSearchIndex === -1) return;
            const result = searchResults[currentSearchIndex];
            const newVal = replaceInput.value;
            contentInput.value = contentInput.value.substring(0, result.start) + newVal + contentInput.value.substring(result.end);
            history.push(contentInput.value);
            performSearch(); renderPreview(); handleInput();
        }

        function replaceAll() {
            const query = findInput.value;
            if (!query) return;
            const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            const matches = contentInput.value.match(regex);
            if (!matches) return;
            contentInput.value = contentInput.value.replace(regex, replaceInput.value);
            history.push(contentInput.value);
            performSearch(); renderPreview(); handleInput();
            showToast(`Đã thay thế ${matches.length} vị trí!`);
        }

        // Clipboard & Actions
        window.addEventListener('contextmenu', (e) => {
            if (e.target.id !== 'noteContent' && e.target.id !== 'previewPane') return;
            e.preventDefault();
            contextMenu.style.display = 'block';
            contextMenu.style.left = Math.min(e.pageX, window.innerWidth - 230) + 'px';
            contextMenu.style.top = Math.min(e.pageY, window.innerHeight - 300) + 'px';
        });

        async function handleMenuAction(action) {
            contentInput.focus();
            const start = contentInput.selectionStart;
            const end = contentInput.selectionEnd;
            const selectedText = contentInput.value.substring(start, end);

            switch(action) {
                case 'undo': 
                    const prev = history.undo();
                    if (prev !== null) { contentInput.value = prev; renderPreview(); handleInput(); }
                    break;
                case 'redo':
                    const next = history.redo();
                    if (next !== null) { contentInput.value = next; renderPreview(); handleInput(); }
                    break;
                case 'cut':
                    if (start !== end) {
                        await navigator.clipboard.writeText(selectedText);
                        contentInput.value = contentInput.value.substring(0, start) + contentInput.value.substring(end);
                        history.push(contentInput.value);
                        renderPreview(); handleInput();
                    }
                    break;
                case 'copy':
                    if (start !== end) await navigator.clipboard.writeText(selectedText);
                    break;
                case 'paste': 
                    try {
                        const text = await navigator.clipboard.readText();
                        contentInput.setRangeText(text, start, end, 'end');
                        history.push(contentInput.value);
                        renderPreview(); handleInput();
                    } catch (err) { showToast("Cần cấp quyền Clipboard!"); }
                    break;
                case 'select-all': contentInput.select(); break;
            }
        }

        function showToast(msg) {
            toast.innerText = msg; toast.classList.add("show");
            setTimeout(() => { toast.classList.remove("show"); }, 3000);
        }

        function showAutoSavePrompt() {
    autoSavePrompt.classList.remove('hidden');
}

function closeAutoSavePrompt() {
    autoSavePrompt.classList.add('hidden');
}

function enableAutoSave() {
    autoSaveToggle.checked = true;
    closeAutoSavePrompt();
}


        setTimeout(() => { brandLogo.classList.add('collapsed'); }, 2000);

        function renderPreview() {
            if (isMarkdown) {
                const dirty = marked.parse(contentInput.value);
                previewPane.innerHTML = DOMPurify.sanitize(dirty);
            }
        }

        function updateSaveUI() {
            const hasHandle = !!fileHandle;
            if (hasHandle && 'showOpenFilePicker' in window) {
                autoSaveContainer.style.display = 'flex';
                mainSaveBtn.classList.remove('hidden');
            } else {
                autoSaveContainer.style.display = 'none';
                mainSaveBtn.classList.add('hidden');
            }
        }

contentInput.addEventListener('keydown', (e) => {
    const cursor = contentInput.selectionStart, end = contentInput.selectionEnd;

    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); handleMenuAction('undo'); return; }
    if (e.ctrlKey && e.key === 'y') { e.preventDefault(); handleMenuAction('redo'); return; }

    if (e.ctrlKey) {
        if (e.key === 's' && !e.shiftKey) { 
            e.preventDefault(); 
            saveFile(); 
            return;
        }

        // ⭐ Ctrl + Shift + S → Lưu tệp mới
        if (e.key === 'S' || (e.key === 's' && e.shiftKey)) {
            e.preventDefault();
            saveFileAs();   // nhớ phải có hàm này nha
            return;
        }

        if (e.key === 'o') { e.preventDefault(); openFile(); return; }

        // ⭐ Ctrl + N → kiểm tra chưa lưu
        if (e.key === 'n') {
            e.preventDefault();

            if (!isSaved) {
                const confirmNew = confirm("Tệp chưa được lưu. Vẫn tạo tệp mới?");
                if (!confirmNew) return;
            }

            newFile();
            return;
        }

        if (e.key === 'f') { e.preventDefault(); toggleFindReplace(); return; }
    }

    if (e.key === 'Escape' && findReplaceBar.style.display === 'flex') toggleFindReplace();

    if (e.key === 'Tab') {
        e.preventDefault();
        contentInput.value =
            contentInput.value.substring(0, cursor) +
            "    " +
            contentInput.value.substring(end);

        contentInput.setSelectionRange(cursor + 4, cursor + 4);
        history.push(contentInput.value);
    }

    if (cursor === end) {
        const pairs = { '"': '"', "'": "'", "(": ")", "[": "]", "{": "}", "`": "`", "*": "*", "_": "_" };
        if (pairs[e.key]) {
            e.preventDefault();
            contentInput.value =
                contentInput.value.substring(0, cursor) +
                e.key + pairs[e.key] +
                contentInput.value.substring(cursor);

            contentInput.setSelectionRange(cursor + 1, cursor + 1);
            history.push(contentInput.value);
        }
    }
});


        let inputTimer;
        contentInput.addEventListener('input', () => { 
            isSaved = false;
            renderPreview(); handleInput();
            updateWordCount();
            if (findReplaceBar.style.display === 'flex') performSearch();
            clearTimeout(inputTimer);
            inputTimer = setTimeout(() => history.push(contentInput.value), 500);
        });

        function checkFileType(fileName) {
            isMarkdown = fileName.toLowerCase().endsWith('.md');
            if (isMarkdown) {
                mdToolbar.classList.replace('opacity-0', 'opacity-100');
                mdToolbar.classList.remove('pointer-events-none');
                previewPane.classList.add('active');
            } else {
                mdToolbar.classList.replace('opacity-100', 'opacity-0');
                mdToolbar.classList.add('pointer-events-none');
                previewPane.classList.remove('active');
            }
        }

        function insertMD(prefix, suffix) {
            const start = contentInput.selectionStart, end = contentInput.selectionEnd;
            contentInput.value = contentInput.value.substring(0, start) + prefix + contentInput.value.substring(start, end) + suffix + contentInput.value.substring(end);
            contentInput.focus();
            const newPos = start + prefix.length + (end - start);
            contentInput.setSelectionRange(newPos, newPos);
            history.push(contentInput.value);
            renderPreview();
        }

   async function openFile() {
    try {
        const [handle] = await window.showOpenFilePicker({
            types: [
                {
                    description: "Supported text/code files",
                    accept: {
                        "text/plain": [".txt", ".md", ".json"],
                        "text/html": [".html", ".htm"],
                        "text/css": [".css"],
                        "application/javascript": [".js"],
                        "application/x-bat": [".bat"],
                        "text/x-python": [".py"],
                        "text/x-powershell": [".ps1"]
                    }
                }
            ],
            excludeAcceptAllOption: true,
            multiple: false
        });

        await loadFileFromHandle(handle);
    } catch (err) {}
}


        async function saveFile() {
            if (!fileHandle) return saveFileAs();
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(contentInput.value);
                await writable.close();
        
                isSaved = true;
                updateWindowTitle();
                saveStatus.style.opacity = '1';
                setTimeout(() => { saveStatus.style.opacity = '0'; }, 1500);
            } catch (err) { showToast("Lỗi ghi file!"); }
        }

async function saveFileAs() {
    try {
        fileHandle = await window.showSaveFilePicker({
            suggestedName: "no_name.txt",
            types: [
                {
                    description: "Text file",
                    accept: { "text/plain": [".txt"] }
                }
            ]
        });

        await saveFile();

        const file = await fileHandle.getFile();
        titleInput.value = file.name;   // ← giữ nguyên extension
        checkFileType(file.name);
        updateSaveUI();
        updateWindowTitle();            // ← NÉM Ở ĐÂY

    } catch (err) {}
}



function newFile() {
    // Nếu chưa lưu thì hỏi trước
    if (!isSaved) {
        const confirmNew = confirm("Tệp chưa được lưu. Bạn có muốn tạo tệp mới không?");
        if (!confirmNew) return;
    }

    // Reset file
    fileHandle = null;
    contentInput.value = '';

    history.push("");
    checkFileType("");

    // đặt tên mặc định SAU khi reset
    titleInput.value = "No_name.txt";
    updateWindowTitle();

    isSaved = true;
    updateSaveUI();

    renderPreview();
    updateWordCount();
}


        let autoSaveTimeout = null;
        function handleInput() {
            if (autoSaveToggle.checked && fileHandle) {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveFile, 1000);
            }
        }

        window.addEventListener('beforeunload', (e) => {
    if (!isSaved) {
        e.preventDefault();
        e.returnValue = '';
    }
});


       function updateWordCount() {
    const text = contentInput.value;

    const chars = text.length;
    const words = text.trim() === "" ? 0 : text.trim().split(/\s+/).length;

    wordCount.textContent = `${chars} ký tự • ${words} từ`;
}

        // --- Block all manual reload attempts ---
window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();

    // F5 hoặc Ctrl+R hoặc Ctrl+Shift+R
    if (key === 'f5' || (e.ctrlKey && key === 'r')) {
        e.preventDefault();
    }
});

    function restartApp() {
    if (!isSaved) {
        const ok = confirm("Nội dung chưa được lưu. Bạn vẫn muốn khởi động lại?");
        if (!ok) return;
    }
    location.reload();
}

        document.addEventListener('keydown', (e) => {
    // Ctrl + N
    if (e.ctrlKey && e.key.toLowerCase() === 'n') {
        e.preventDefault();
        newFile();
    }
});

        function updateWindowTitle() {
    let name = titleInput.value.trim();

    if (!name) {
        document.title = "No_name.txt";
        return;
    }

    document.title = name;
}

    </script>
    
</body>
</html>
